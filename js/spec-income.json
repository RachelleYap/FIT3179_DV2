{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "background": "white",
  "width": 520,
  "height": 420,
  "datasets": {
    "incomeData": [
      { "state": "Johor", "income_mean": 8517, "income_median": 6879 },
      { "state": "Kedah", "income_mean": 5550, "income_median": 4402 },
      { "state": "Kelantan", "income_mean": 4885, "income_median": 3614 },
      { "state": "Malacca", "income_mean": 8057, "income_median": 6210 },
      { "state": "Negeri Sembilan", "income_mean": 6788, "income_median": 5226 },
      { "state": "Pahang", "income_mean": 5777, "income_median": 4753 },
      { "state": "Perak", "income_mean": 5779, "income_median": 4494 },
      { "state": "Perlis", "income_mean": 5664, "income_median": 4713 },
      { "state": "Penang", "income_mean": 8267, "income_median": 6502 },
      { "state": "Sabah", "income_mean": 6171, "income_median": 4577 },
      { "state": "Sarawak", "income_mean": 6457, "income_median": 4978 },
      { "state": "Selangor", "income_mean": 12233, "income_median": 9983 },
      { "state": "Terengganu", "income_mean": 7248, "income_median": 5878 },
      { "state": "Kuala Lumpur", "income_mean": 13325, "income_median": 10234 },
      { "state": "Labuan", "income_mean": 8250, "income_median": 6904 },
      { "state": "Putrajaya", "income_mean": 13473, "income_median": 10056 }
    ]
  },
  "projection": {
    "type": "mercator",
    "center": { "expr": "[mapCenterLon, mapCenterLat]" },
    "scale": { "expr": "mapScale" }
  },
  "params": [
    { "name": "minIncome", "value": 0 },
    { "name": "stateFilter", "value": null },
    { "name": "mapScale", "value": 1300 },
    { "name": "mapCenterLon", "value": 110 },
    { "name": "mapCenterLat", "value": 4.5 }
  ],
  "layer": [
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
        "format": { "type": "topojson", "feature": "oceans" }
      },
      "mark": { "type": "geoshape", "fill": "#cce5ff" }
    },
    {
      "data": { "graticule": { "step": [1, 1] } },
      "mark": { "type": "geoshape", "stroke": "#cccccc", "strokeWidth": 1, "fill": null }
    },
    {
      "data": {
        "url": "js/ne_10m_admin_1_states_provinces.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        { "filter": "datum.properties.iso_a2 === 'MY'" },
        {
          "calculate": "datum.properties.name === 'Wilayah Persekutuan Kuala Lumpur' ? 'Kuala Lumpur' : datum.properties.name === 'Wilayah Persekutuan Labuan' ? 'Labuan' : datum.properties.name === 'Wilayah Persekutuan Putrajaya' ? 'Putrajaya' : datum.properties.name === 'Pulau Pinang' ? 'Penang' : datum.properties.name === 'Melaka' ? 'Malacca' : datum.properties.name",
          "as": "state"
        },
        {
          "lookup": "state",
          "from": { "data": { "name": "incomeData" }, "key": "state", "fields": ["income_median"] }
        },
        { "filter": "isValid(datum.income_median) && datum.income_median >= minIncome" },
        { "filter": "!stateFilter || datum.state === stateFilter" }
      ],
      "mark": { "type": "geoshape", "stroke": "#444", "strokeWidth": 0.6 },
      "encoding": {
        "color": {
          "field": "income_median",
          "type": "quantitative",
          "scale": { "type": "quantize", "domain": [0, 14000], "scheme": "blues" },
          "title": "Median Income (RM)",
          "legend": {
            "title": "Median Income (RM)",
            "orient": "bottom",
            "gradientLength": 200,
            "format": ",.0f",
            "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 1000) * 1000, ',.0f') : ''"
          }
        },
        "tooltip": [
          { "field": "state", "title": "State" },
          { "field": "income_median", "title": "Median Income (RM)", "format": ",.0f" }
        ]
      }
    },
    {
      "data": {
        "values": [
          {
            "state": "Putrajaya",
            "compareValue": 10056,
            "anchorLon": 101.7,
            "anchorLat": 2.8,
            "textLon": 104,
            "textLat": 8.1,
            "label": "Highest Median Income: Putrajaya (RM 10,056)"
          }
        ]
      },
      "transform": [
        {
          "filter": "(!stateFilter || stateFilter === datum.state) && datum.compareValue >= minIncome"
        }
      ],
      "layer": [
        {
          "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2] },
          "encoding": {
            "longitude": { "field": "anchorLon" },
            "latitude": { "field": "anchorLat" },
            "longitude2": { "field": "textLon" },
            "latitude2": { "field": "textLat" }
          }
        },
        {
          "mark": {
            "type": "text",
            "fontSize": 12,
            "fontWeight": "bold",
            "fill": "black",
            "align": "left",
            "baseline": "top",
            "dx": 6,
            "dy": -6
          },
          "encoding": {
            "text": { "field": "label" },
            "longitude": { "field": "textLon" },
            "latitude": { "field": "textLat" }
          }
        }
      ]
    }
  ]
}
