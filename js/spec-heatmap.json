{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "background": "white",
  "width": 860,
  "height": 420,
  "datasets": {
    "combinedData": [
      { "state": "Johor", "income_mean": 8517, "income_median": 6879, "poverty_absolute": 4.6, "poverty_hardcore": 0.1, "poverty_relative": 15.9, "region": "Peninsular" },
      { "state": "Kedah", "income_mean": 5550, "income_median": 4402, "poverty_absolute": 9, "poverty_hardcore": 0.3, "poverty_relative": 11.9, "region": "Peninsular" },
      { "state": "Kelantan", "income_mean": 4885, "income_median": 3614, "poverty_absolute": 13.2, "poverty_hardcore": 0.8, "poverty_relative": 12.2, "region": "Peninsular" },
      { "state": "Malacca", "income_mean": 8057, "income_median": 6210, "poverty_absolute": 4.2, "poverty_hardcore": 0.1, "poverty_relative": 13.2, "region": "Peninsular" },
      { "state": "Negeri Sembilan", "income_mean": 6788, "income_median": 5226, "poverty_absolute": 4.4, "poverty_hardcore": 0.1, "poverty_relative": 13.3, "region": "Peninsular" },
      { "state": "Pahang", "income_mean": 5777, "income_median": 4753, "poverty_absolute": 6.3, "poverty_hardcore": 0.1, "poverty_relative": 7.7, "region": "Peninsular" },
      { "state": "Perak", "income_mean": 5779, "income_median": 4494, "poverty_absolute": 7.5, "poverty_hardcore": 0.2, "poverty_relative": 13.5, "region": "Peninsular" },
      { "state": "Perlis", "income_mean": 5664, "income_median": 4713, "poverty_absolute": 4, "poverty_hardcore": 0.1, "poverty_relative": 12.6, "region": "Peninsular" },
      { "state": "Penang", "income_mean": 8267, "income_median": 6502, "poverty_absolute": 2, "poverty_hardcore": 0.1, "poverty_relative": 15.3, "region": "Peninsular" },
      { "state": "Sabah", "income_mean": 6171, "income_median": 4577, "poverty_absolute": 19.7, "poverty_hardcore": 1.2, "poverty_relative": 14.5, "region": "East Malaysia" },
      { "state": "Sarawak", "income_mean": 6457, "income_median": 4978, "poverty_absolute": 10.8, "poverty_hardcore": 0.4, "poverty_relative": 16.2, "region": "East Malaysia" },
      { "state": "Selangor", "income_mean": 12233, "income_median": 9983, "poverty_absolute": 1.5, "poverty_hardcore": 0, "poverty_relative": 14.2, "region": "Peninsular" },
      { "state": "Terengganu", "income_mean": 7248, "income_median": 5878, "poverty_absolute": 6.2, "poverty_hardcore": 0.2, "poverty_relative": 6.9, "region": "Peninsular" },
      { "state": "Kuala Lumpur", "income_mean": 13325, "income_median": 10234, "poverty_absolute": 1.4, "poverty_hardcore": 0, "poverty_relative": 12.7, "region": "Peninsular" },
      { "state": "Labuan", "income_mean": 8250, "income_median": 6904, "poverty_absolute": 2.5, "poverty_hardcore": 0, "poverty_relative": 7, "region": "East Malaysia" },
      { "state": "Putrajaya", "income_mean": 13473, "income_median": 10056, "poverty_absolute": 0.1, "poverty_hardcore": 0, "poverty_relative": 11.4, "region": "Peninsular" }
    ]
  },
  "data": { "name": "combinedData" },
  "params": [ { "name": "stateFilter", "value": null } ],
  "transform": [
    { "filter": "!stateFilter || datum.state === stateFilter" },
    { "fold": [ "income_median", "poverty_absolute", "poverty_hardcore", "poverty_relative" ], "as": [ "metric", "value" ] },
    { "calculate": "datum.metric === 'income_median' ? 'Median income (RM)' : datum.metric === 'poverty_absolute' ? 'Absolute poverty (%)' : datum.metric === 'poverty_hardcore' ? 'Hardcore poverty (%)' : 'Relative poverty (%)'", "as": "metricLabel" },
    { "joinaggregate": [ { "op": "min", "field": "value", "as": "mmin" }, { "op": "max", "field": "value", "as": "mmax" }, { "op": "count", "field": "value", "as": "mcount" } ], "groupby": [ "metric" ] },
    { "calculate": "(datum.value - datum.mmin) / (datum.mmax - datum.mmin)", "as": "norm" },
    { "calculate": "datum.metric === 'income_median' ? datum.norm : 1 - datum.norm", "as": "score" },
    { "window": [ { "op": "rank", "as": "rank_desc" } ], "sort": [ { "field": "value", "order": "descending" } ], "frame": [ null, null ], "groupby": [ "metric" ] },
    { "calculate": "datum.metric === 'income_median' ? format(datum.value, ',.0f') : format(datum.value, '.1f')", "as": "valueLabel" },
    { "calculate": "format(datum.score, '.2f')", "as": "scoreLabel" }
  ],
  "layer": [
    {
      "mark": "rect",
      "encoding": {
        "y": { "field": "state", "type": "ordinal", "sort": { "field": "income_median", "order": "descending" }, "title": "State" },
        "x": { "field": "metricLabel", "type": "ordinal", "sort": [ "Median income (RM)", "Absolute poverty (%)", "Hardcore poverty (%)", "Relative poverty (%)" ], "axis": { "labelAngle": 0 }, "title": null },
        "color": { "field": "score", "type": "quantitative", "scale": { "type": "quantile", "scheme": "blues" }, "title": "Score", "legend": { "title": "Score (Bluer = Better)", "orient": "bottom", "gradientLength": 240, "format": ".1f", "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 0.2) * 0.2, '.1f') : ''" } },
        "stroke": {
          "condition": [
            { "test": "datum.metric === 'income_median' && datum.rank_desc === 1", "value": "#0d1b2a" },
            { "test": "datum.metric === 'poverty_absolute' && datum.rank_desc === 1", "value": "#b22222" },
            { "test": "datum.metric === 'poverty_absolute' && datum.rank_desc === datum.mcount", "value": "#1f78b4" }
          ],
          "value": null
        },
        "strokeWidth": {
          "condition": [
            { "test": "datum.metric === 'income_median' && datum.rank_desc === 1", "value": 2 },
            { "test": "datum.metric === 'poverty_absolute' && (datum.rank_desc === 1 || datum.rank_desc === datum.mcount)", "value": 2 }
          ],
          "value": 0
        },
        "tooltip": [
          { "field": "state", "title": "State" },
          { "field": "metricLabel", "title": "Metric" },
          { "field": "valueLabel", "title": "Original Value" },
          { "field": "scoreLabel", "title": "Normalised Value" }
        ]
      }
    },
    {
      "mark": { "type": "text", "fontSize": 10, "baseline": "middle", "align": "center" },
      "encoding": {
        "y": { "field": "state", "type": "ordinal", "sort": { "field": "income_median", "order": "descending" } },
        "x": { "field": "metricLabel", "type": "ordinal", "sort": [ "Median income (RM)", "Absolute poverty (%)", "Hardcore poverty (%)", "Relative poverty (%)" ] },
        "text": { "field": "valueLabel" },
        "color": {
          "condition": [
            { "test": "datum.score >= 0.6", "value": "white" },
            { "test": "datum.score <= 0.25", "value": "#0d1b2a" }
          ],
          "value": "#0f3057"
        }
      }
    }
  ]
}
