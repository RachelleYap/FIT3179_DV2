{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "background": "white",
  "width": 520,
  "height": 420,
  "datasets": {
    "povertyData": [
      { "state": "Johor", "poverty_absolute": 4.6, "poverty_hardcore": 0.1, "poverty_relative": 15.9 },
      { "state": "Kedah", "poverty_absolute": 9, "poverty_hardcore": 0.3, "poverty_relative": 11.9 },
      { "state": "Kelantan", "poverty_absolute": 13.2, "poverty_hardcore": 0.8, "poverty_relative": 12.2 },
      { "state": "Malacca", "poverty_absolute": 4.2, "poverty_hardcore": 0.1, "poverty_relative": 13.2 },
      { "state": "Negeri Sembilan", "poverty_absolute": 4.4, "poverty_hardcore": 0.1, "poverty_relative": 13.3 },
      { "state": "Pahang", "poverty_absolute": 6.3, "poverty_hardcore": 0.1, "poverty_relative": 7.7 },
      { "state": "Perak", "poverty_absolute": 7.5, "poverty_hardcore": 0.2, "poverty_relative": 13.5 },
      { "state": "Perlis", "poverty_absolute": 4, "poverty_hardcore": 0.1, "poverty_relative": 12.6 },
      { "state": "Penang", "poverty_absolute": 2, "poverty_hardcore": 0.1, "poverty_relative": 15.3 },
      { "state": "Sabah", "poverty_absolute": 19.7, "poverty_hardcore": 1.2, "poverty_relative": 14.5 },
      { "state": "Sarawak", "poverty_absolute": 10.8, "poverty_hardcore": 0.4, "poverty_relative": 16.2 },
      { "state": "Selangor", "poverty_absolute": 1.5, "poverty_hardcore": 0, "poverty_relative": 14.2 },
      { "state": "Terengganu", "poverty_absolute": 6.2, "poverty_hardcore": 0.2, "poverty_relative": 6.9 },
      { "state": "Kuala Lumpur", "poverty_absolute": 1.4, "poverty_hardcore": 0, "poverty_relative": 12.7 },
      { "state": "Labuan", "poverty_absolute": 2.5, "poverty_hardcore": 0, "poverty_relative": 7 },
      { "state": "Putrajaya", "poverty_absolute": 0.1, "poverty_hardcore": 0, "poverty_relative": 11.4 }
    ]
  },
  "projection": {
    "type": "mercator",
    "center": { "expr": "[mapCenterLon, mapCenterLat]" },
    "scale": { "expr": "mapScale" }
  },
  "params": [
    { "name": "minPoverty", "value": 0 },
    { "name": "stateFilter", "value": null },
    { "name": "mapScale", "value": 1300 },
    { "name": "mapCenterLon", "value": 110 },
    { "name": "mapCenterLat", "value": 4.5 }
  ],
  "layer": [
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
        "format": { "type": "topojson", "feature": "oceans" }
      },
      "mark": { "type": "geoshape", "fill": "#cce5ff" }
    },
    {
      "data": { "graticule": { "step": [1, 1] } },
      "mark": { "type": "geoshape", "stroke": "#cccccc", "strokeWidth": 1, "fill": null }
    },
    {
      "data": {
        "url": "js/ne_10m_admin_1_states_provinces.json",
        "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" }
      },
      "transform": [
        { "filter": "datum.properties.iso_a2 === 'MY'" },
        {
          "calculate": "datum.properties.name === 'Wilayah Persekutuan Kuala Lumpur' ? 'Kuala Lumpur' : datum.properties.name === 'Wilayah Persekutuan Labuan' ? 'Labuan' : datum.properties.name === 'Wilayah Persekutuan Putrajaya' ? 'Putrajaya' : datum.properties.name === 'Pulau Pinang' ? 'Penang' : datum.properties.name === 'Melaka' ? 'Malacca' : datum.properties.name",
          "as": "state"
        },
        {
          "lookup": "state",
          "from": {
            "data": { "name": "povertyData" },
            "key": "state",
            "fields": [ "poverty_absolute", "poverty_hardcore", "poverty_relative" ]
          }
        },
        { "filter": "isValid(datum.poverty_absolute) && datum.poverty_absolute >= minPoverty" },
        { "filter": "!stateFilter || datum.state === stateFilter" }
      ],
      "mark": { "type": "geoshape", "stroke": "#444", "strokeWidth": 0.6 },
      "encoding": {
        "color": {
          "field": "poverty_absolute",
          "type": "quantitative",
          "scale": { "type": "quantize", "domain": [0, 20], "scheme": "reds" },
          "title": "Absolute Poverty (%)",
          "legend": {
            "title": "Absolute Poverty (%)",
            "orient": "bottom",
            "gradientLength": 200,
            "format": ".1f",
            "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 2) * 2, '.0f') : ''"
          }
        },
        "tooltip": [
          { "field": "state", "title": "State" },
          { "field": "poverty_absolute", "title": "Absolute Poverty (%)", "format": ".1f" },
          { "field": "poverty_hardcore", "title": "Hardcore Poverty (%)", "format": ".1f" },
          { "field": "poverty_relative", "title": "Relative Poverty (%)", "format": ".1f" }
        ]
      }
    },
    {
      "data": {
        "values": [
          {
            "state": "Sabah",
            "compareValue": 19.7,
            "anchorLon": 116,
            "anchorLat": 5.7,
            "textLon": 110.5,
            "textLat": 8,
            "label": "Highest Poverty: Sabah (19.7%)"
          }
        ]
      },
      "transform": [
        {
          "filter": "(!stateFilter || stateFilter === datum.state) && datum.compareValue >= minPoverty"
        }
      ],
      "layer": [
        {
          "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2] },
          "encoding": {
            "longitude": { "field": "anchorLon" },
            "latitude": { "field": "anchorLat" },
            "longitude2": { "field": "textLon" },
            "latitude2": { "field": "textLat" }
          }
        },
        {
          "mark": {
            "type": "text",
            "fontSize": 12,
            "fontWeight": "bold",
            "fill": "black",
            "align": "left",
            "baseline": "top",
            "dx": 6,
            "dy": -6
          },
          "encoding": {
            "text": { "field": "label" },
            "longitude": { "field": "textLon" },
            "latitude": { "field": "textLat" }
          }
        }
      ]
    }
  ]
}
