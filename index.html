<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Economic Inequality and Living Standards Across Malaysian States (2022)</title>
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');


body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin: 20px;
  background-color: #eafbff;
  font-size: 17px;
  line-height: 1.7;
  color: #000;
}
.container { display: grid; grid-template-columns: repeat(auto-fit, minmax(540px, 1fr)); gap: 32px; max-width: 1200px; margin: 0 auto; justify-items: center; }
.container-wide { display: grid; grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); gap: 72px; max-width: 1200px; margin: 0 auto; align-items: start; justify-items: center; }
.vis-section { max-width: 520px; margin: 0 auto; width: 100%; text-align: center; background: #ffffffbe; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
.vis-section.wide { max-width: 980px; }
.vis-section > div[id^="vis-"] { margin: 0 auto; }
.vis-section h3 { margin-bottom: 16px; }
#vis-income, #vis-poverty, #vis-scatter, #vis-bar, #vis-small-multiples { max-width: 100%; margin: 16px auto; }
#vis-scatter, #vis-bar, #vis-small-multiples { display: flex; justify-content: center; }
#vis-scatter > div, #vis-bar > div, #vis-small-multiples > div { margin: 0 auto; }
#vis-small-multiples { flex: 0 0 auto; display: inline-block; background: #ffffffbe; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
label { font-size: 16px; margin-right: 10px; }
input[type="range"] { width: 80%; max-width: 400px; }
.note { max-width: 1200px; margin: 20px auto; font-size: 15px; color: #000; }
.meta { max-width: 1200px; margin: 40px auto 20px; text-align: center; font-size: 15px; color: #000; background: rgba(255,255,255,0.7); padding: 18px 24px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.08); }
.meta a { color: #000; text-decoration: none; font-weight: 600; }
.meta a:hover { text-decoration: underline; }
h1 { text-align: center; font-family: 'Times New Roman', serif; letter-spacing: 0.5px; font-size: 40px; }
h2 { text-align: center; font-family: 'Times New Roman', serif; font-size: 30px; }
h3 { text-align: center; font-family: 'Times New Roman', serif; font-size: 22px; }
.full-row { max-width: 1200px; margin: 0 auto; width: 100%; display: flex; justify-content: center; }
.flex-center { display: flex; justify-content: center; width: 100%; }
.story-paragraph { max-width: 1200px; margin: 20px auto; font-size: 17px; line-height: 1.7; }
.story-paragraph p { text-align: justify; margin-bottom: 1em; }
.story-paragraph.columns { display: flex; gap: 48px; align-items: flex-start; }
.story-paragraph.columns p { flex: 1 1 0; margin: 0; }
@media (max-width: 900px) {
.story-paragraph.columns { flex-direction: column; gap: 16px; }
}
.note, .note li { text-align: justify; }
.domain-info { max-width: 1200px; margin: 20px auto; font-size: 16px; font-weight: bold; }
.state-filter-controls { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 10px auto 30px; font-weight: 600; }
.state-filter-controls button { padding: 6px 14px; border: 1px solid #888; background: white; border-radius: 4px; cursor: pointer; }
.state-filter-controls button:hover { background: #e5fbff; }
.map-controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 14px; margin: 10px auto 20px; }
.map-controls label { font-size: 13px; font-weight: 600; margin-right: 4px; }
.map-controls input[type="range"] { width: 160px; max-width: none; }
.map-controls select { padding: 4px 10px; border: 1px solid #888; border-radius: 4px; background: white; cursor: pointer; }
.vega-embed { margin: 0 auto; }
</style>
</head>
<body>
<h1>Economic Inequality and Living Standards Across Malaysian States (2022)</h1>
<div class="state-filter-controls">
<span id="state-filter-status">Showing: All states</span>
<button id="state-filter-clear" type="button">Clear filter</button>
</div>
<div class="story-paragraph columns">
<p>This dashboard examines regional inequality in income and living standards across Malaysian states in 2022. The visuals show that prosperity is concentrated in urbanised areas, while many rural and East Malaysian regions still face persistent poverty.</p>
<p>Overall, the findings highlight that economic growth in Malaysia remains uneven, underscoring the need for more inclusive development across all regions.</p>
</div>




<div class="note">
<strong>Indicator definitions:</strong>
<ul>
  <li><strong>Income Mean</strong>: Average monthly household income.</li>
  <li><strong>Income Median</strong>: Middle value of household income; usually lower than the mean because of income inequality.</li>
  <li><strong>Poverty Absolute</strong>: Percentage of households earning below the Poverty Line Income (PLI).</li>
  <li><strong>Poverty Hardcore</strong>: Percentage of households earning below the Food Poverty Line Income (Food PLI).</li>
  <li><strong>Poverty Relative</strong>: Percentage of households earning below half of their state’s median income.</li>
</ul>
</div>








<h2>Regional Income and Poverty Distribution Across Malaysian States</h2>
<div class="story-paragraph columns" style="margin-top: 8px;">
<p>Users can adjust the zoom to examine specific areas more closely or use the focus option to highlight a particular state.</p>
<p>The interactive sliders also allow users to filter states by income and poverty thresholds.</p>
</div>
<div class="map-controls">
<label for="map-zoom">Zoom:</label>
<input type="range" id="map-zoom" min="700" max="2200" step="50" value="1300">
<label for="map-center">Focus:</label>
<select id="map-center">
 <option value="national">Whole Malaysia</option>
 <option value="peninsular">Peninsular Malaysia</option>
 <option value="east">East Malaysia</option>
</select>
</div>
<div class="story-paragraph columns">
<p>These choropleth maps illustrate the geographic distribution of median household income and absolute poverty rates across Malaysian states in 2022. The map on the left shades states according to income levels, where darker blue tones represent higher median incomes, indicating greater economic prosperity.</p>
<p>In contrast, the map on the right uses red tones to represent absolute poverty rates, where darker shades indicate higher poverty levels. This highlights the regional imbalance, with urban states showing greater prosperity while rural and East Malaysian regions remain more affected by poverty.</p>
</div>
<div class="container">
<div class="vis-section">
 <h3>Median Household Income</h3>
 <div id="income-slider-container" style="text-align:center;margin:20px 0;">
   <label for="income-slider">Filter by Minimum Median Income (RM): </label>
    <input type="range" id="income-slider" min="0" max="12000" step="50" value="0">
    <span id="slider-value-income">0</span>
  </div>
  <div id="vis-income"></div>
</div>


<div class="vis-section">
  <h3>Absolute Poverty Rate</h3>
  <div id="poverty-slider-container" style="text-align:center;margin:20px 0;">
    <label for="poverty-slider">Filter by Minimum Absolute Poverty (%): </label>
    <input type="range" id="poverty-slider" min="0" max="20" step="0.1" value="0">
    <span id="slider-value-poverty">0</span>
  </div>
  <div id="vis-poverty"></div>
</div>
</div>


<h2>The Income–Poverty Gap Across Malaysian States</h2>
<div class="story-paragraph columns">
<p>The visualisation shows a negative relationship between median income and absolute poverty, where states with higher incomes generally have lower poverty rates. <strong>Sabah</strong> stands out as an outlier with the highest poverty rate despite having only a moderately low median income, suggesting other factors may be driving its poverty levels.</p>
<p>In contrast, <strong>Kuala Lumpur</strong>, <strong>Selangor</strong>, and <strong>Putrajaya</strong> form a cluster of high-income, low-poverty states, reflecting stronger economies and better living conditions. In addition, the State Income Brush below lets users highlight and compare states by income, helping to visualise overall disparities across Malaysia.</p>
</div>
<div class="full-row flex-center">
<div class="vis-section wide">
  <h3>Median Income vs Absolute Poverty</h3>
  <div id="vis-scatter"></div>
</div>
</div>


<h2>Comparative State Performance Across Metrics</h2>
<div class="story-paragraph columns">
<p>This heatmap compares economic well-being across Malaysian states, where deeper blues signal stronger performance. Indicators such as median household income and poverty measures provide a multidimensional view of living standards. <strong>Kuala Lumpur</strong>, <strong>Putrajaya</strong>, and <strong>Selangor</strong> shine with the boldest blues and lowest poverty levels, reflecting high prosperity and stability.</p>
<p>In contrast, <strong>Sabah</strong> and <strong>Kelantan</strong> display paler tones alongside deeper poverty hues, highlighting ongoing disparities. Overall, the visual reveals a clear urban–rural divide, where economic opportunities and better living conditions remain concentrated in developed regions.</p>
</div>
<div class="full-row">
<div class="vis-section wide">
  <div id="vis-bar"></div>
</div>
</div>


<h2>State-by-State Comparison of Key Socioeconomic Indicators</h2>
<div class="story-paragraph columns" style="margin-top: 8px;">
<p>The small multiples break down each metric by state, providing a concise grid of comparisons that highlights regional strengths and weaknesses at a glance. States that consistently appear at the top across multiple charts signal broad-based resilience, while those clustering at the bottom warrant closer attention.</p>
<p><strong>Sabah</strong> stands out with high poverty rates across all measures, underscoring persistent hardship, whereas <strong>Putrajaya</strong> and <strong>Kuala Lumpur</strong> maintain strong income levels across both mean and median indicators. The paired views reinforce how economic resilience and vulnerability are distributed across the country.</p>
</div>
<div class="full-row">
<div id="vis-small-multiples"></div>
</div>


<footer class="meta">
<p><strong>Author:</strong> Rachelle Yap Zen Yi</p>
<p><strong>Date:</strong> 19th October 2025</p>
<p><strong>Data Sources:</strong>
  <a href="https://data.gov.my/data-catalogue/hh_income_state" target="_blank" rel="noopener noreferrer">Income by State</a>
  &nbsp;|&nbsp;
  <a href="https://open.dosm.gov.my/data-catalogue/hh_poverty_state" target="_blank" rel="noopener noreferrer">Poverty by State</a>
</p>
</footer>


<script>
/* -------------------- Data -------------------- */
function normalizeStateName(name) {
const mappings = {
"W.P. Kuala Lumpur": "Kuala Lumpur",
"W.P. Labuan": "Labuan",
"W.P. Putrajaya": "Putrajaya",
"Pulau Pinang": "Penang",
"Melaka": "Malacca"
};
return mappings[name] || name;
}
const incomeData = [
{"state": "Johor", "income_mean": 8517, "income_median": 6879},
{"state": "Kedah", "income_mean": 5550, "income_median": 4402},
{"state": "Kelantan", "income_mean": 4885, "income_median": 3614},
{"state": "Melaka", "income_mean": 8057, "income_median": 6210},
{"state": "Negeri Sembilan", "income_mean": 6788, "income_median": 5226},
{"state": "Pahang", "income_mean": 5777, "income_median": 4753},
{"state": "Perak", "income_mean": 5779, "income_median": 4494},
{"state": "Perlis", "income_mean": 5664, "income_median": 4713},
{"state": "Pulau Pinang", "income_mean": 8267, "income_median": 6502},
{"state": "Sabah", "income_mean": 6171, "income_median": 4577},
{"state": "Sarawak", "income_mean": 6457, "income_median": 4978},
{"state": "Selangor", "income_mean": 12233, "income_median": 9983},
{"state": "Terengganu", "income_mean": 7248, "income_median": 5878},
{"state": "W.P. Kuala Lumpur", "income_mean": 13325, "income_median": 10234},
{"state": "W.P. Labuan", "income_mean": 8250, "income_median": 6904},
{"state": "W.P. Putrajaya", "income_mean": 13473, "income_median": 10056}
].map(d => ({ ...d, state: normalizeStateName(d.state) }));


const povertyData = [
{"state": "Johor", "poverty_absolute": 4.6, "poverty_hardcore": 0.1, "poverty_relative": 15.9},
{"state": "Kedah", "poverty_absolute": 9.0, "poverty_hardcore": 0.3, "poverty_relative": 11.9},
{"state": "Kelantan", "poverty_absolute": 13.2, "poverty_hardcore": 0.8, "poverty_relative": 12.2},
{"state": "Melaka", "poverty_absolute": 4.2, "poverty_hardcore": 0.1, "poverty_relative": 13.2},
{"state": "Negeri Sembilan", "poverty_absolute": 4.4, "poverty_hardcore": 0.1, "poverty_relative": 13.3},
{"state": "Pahang", "poverty_absolute": 6.3, "poverty_hardcore": 0.1, "poverty_relative": 7.7},
{"state": "Perak", "poverty_absolute": 7.5, "poverty_hardcore": 0.2, "poverty_relative": 13.5},
{"state": "Perlis", "poverty_absolute": 4.0, "poverty_hardcore": 0.1, "poverty_relative": 12.6},
{"state": "Pulau Pinang", "poverty_absolute": 2.0, "poverty_hardcore": 0.1, "poverty_relative": 15.3},
{"state": "Sabah", "poverty_absolute": 19.7, "poverty_hardcore": 1.2, "poverty_relative": 14.5},
{"state": "Sarawak", "poverty_absolute": 10.8, "poverty_hardcore": 0.4, "poverty_relative": 16.2},
{"state": "Selangor", "poverty_absolute": 1.5, "poverty_hardcore": 0.0, "poverty_relative": 14.2},
{"state": "Terengganu", "poverty_absolute": 6.2, "poverty_hardcore": 0.2, "poverty_relative": 6.9},
{"state": "W.P. Kuala Lumpur", "poverty_absolute": 1.4, "poverty_hardcore": 0.0, "poverty_relative": 12.7},
{"state": "W.P. Labuan", "poverty_absolute": 2.5, "poverty_hardcore": 0.0, "poverty_relative": 7.0},
{"state": "W.P. Putrajaya", "poverty_absolute": 0.1, "poverty_hardcore": 0.0, "poverty_relative": 11.4}
].map(d => ({ ...d, state: normalizeStateName(d.state) }));


const regions = {
"Johor": "Peninsular", "Kedah": "Peninsular", "Kelantan": "Peninsular",
"Malacca": "Peninsular", "Negeri Sembilan": "Peninsular", "Pahang": "Peninsular",
"Perak": "Peninsular", "Perlis": "Peninsular", "Penang": "Peninsular",
"Selangor": "Peninsular", "Terengganu": "Peninsular", "Kuala Lumpur": "Peninsular",
"Putrajaya": "Peninsular", "Sabah": "East Malaysia", "Sarawak": "East Malaysia",
"Labuan": "East Malaysia"
};


const combinedData = incomeData.map(d => ({
...d,
...povertyData.find(p => p.state === d.state),
region: regions[d.state]
}));


const stateDomain = Array.from(new Set(combinedData.map(d => d.state)));
const stateColorRange = [
"#332288", "#88CCEE", "#117733", "#DDCC77",
"#CC6677", "#AA4499", "#44AA99", "#999933",
"#882255", "#6699CC", "#661100", "#AA4466",
"#4477AA", "#77AADD", "#CCDDAA", "#954F72"
];


/* -------------------- Shared map bits -------------------- */
const topoUrl = "ne_10m_admin_1_states_provinces.json"; // local file
const oceansUrl = "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson";


// Normalize Natural Earth names -> our JS data names
const mapNameCalc =
"datum.properties.name === 'Wilayah Persekutuan Kuala Lumpur' ? 'Kuala Lumpur' : " +
"datum.properties.name === 'Wilayah Persekutuan Labuan' ? 'Labuan' : " +
"datum.properties.name === 'Wilayah Persekutuan Putrajaya' ? 'Putrajaya' : " +
"datum.properties.name === 'Pulau Pinang' ? 'Penang' : " +
"datum.properties.name === 'Melaka' ? 'Malacca' : datum.properties.name";


const chartBackground = null;


/* -------------------- Vega-Lite Specs -------------------- */
// Income Map (with oceans + graticules, explicit legend)
const specIncome = {
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"background": chartBackground,
"width": 520, "height": 420,
"projection": {
"type": "mercator",
"center": { "expr": "[mapCenterLon, mapCenterLat]" },
"scale": { "expr": "mapScale" }
},
"params": [
{ "name": "minIncome", "value": 0 },
{ "name": "stateFilter", "value": null },
{ "name": "mapScale", "value": 1300 },
{ "name": "mapCenterLon", "value": 110 },
{ "name": "mapCenterLat", "value": 4.5 }
],
"layer": [
{ "data": { "url": oceansUrl, "format": { "type": "topojson", "feature": "oceans" } },
  "mark": { "type": "geoshape", "fill": "#cce5ff" } },
{ "data": { "graticule": { "step": [1, 1] } },
  "mark": { "type": "geoshape", "stroke": "#cccccc", "strokeWidth": 1, "fill": null } },
{
  "data": { "url": topoUrl, "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" } },
  "transform": [
    { "filter": "datum.properties.iso_a2 === 'MY'" },
    { "calculate": mapNameCalc, "as": "state" },
    { "lookup": "state", "from": { "data": { "values": incomeData }, "key": "state", "fields": ["income_median"] } },
    { "filter": "isValid(datum.income_median) && datum.income_median >= minIncome" },
    { "filter": "!stateFilter || datum.state === stateFilter" }
  ],
  "mark": { "type": "geoshape", "stroke": "#444", "strokeWidth": 0.6 },
  "encoding": {
    "color": { "field": "income_median", "type": "quantitative",
               "scale": { "type": "quantize", "domain": [0, 14000], "scheme": "blues" },
               "title": "Median Income (RM)",
               "legend": {
                 "title": "Median Income (RM)",
                 "orient": "bottom",
                 "gradientLength": 200,
                 "format": ",.0f",
                 "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 1000) * 1000, ',.0f') : ''"
               } },
    "tooltip": [
      { "field": "state", "title": "State" },
      { "field": "income_median", "title": "Median Income (RM)", "format": ",.0f" }
    ]
  }
},
{
  "data": {
    "values": [
      {
        "state": "Putrajaya",
        "compareValue": 10056,
        "anchorLon": 101.7,
        "anchorLat": 2.8,
        "textLon": 104.0,
        "textLat": 8.1,
        "label": "Highest Median Income: Putrajaya (RM 10,056)"
      }
    ]
  },
  "transform": [
    { "filter": "(!stateFilter || stateFilter === datum.state) && datum.compareValue >= minIncome" }
  ],
  "layer": [
    {
      "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2] },
      "encoding": {
        "longitude": { "field": "anchorLon" },
        "latitude": { "field": "anchorLat" },
        "longitude2": { "field": "textLon" },
        "latitude2": { "field": "textLat" }
      }
    },
    {
      "mark": { "type": "text", "fontSize": 12, "fontWeight": "bold", "fill": "black", "align": "left", "baseline": "top", "dx": 6, "dy": -6 },
      "encoding": {
        "text": { "field": "label" },
        "longitude": { "field": "textLon" },
        "latitude": { "field": "textLat" }
      }
    }
  ]
}
]
};


// Poverty Map (with oceans + graticules, explicit legend)
const specPoverty = {
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"background": chartBackground,
"width": 520, "height": 420,
"projection": {
"type": "mercator",
"center": { "expr": "[mapCenterLon, mapCenterLat]" },
"scale": { "expr": "mapScale" }
},
"params": [
{ "name": "minPoverty", "value": 0 },
{ "name": "stateFilter", "value": null },
{ "name": "mapScale", "value": 1300 },
{ "name": "mapCenterLon", "value": 110 },
{ "name": "mapCenterLat", "value": 4.5 }
],
"layer": [
{ "data": { "url": oceansUrl, "format": { "type": "topojson", "feature": "oceans" } },
  "mark": { "type": "geoshape", "fill": "#cce5ff" } },
{ "data": { "graticule": { "step": [1, 1] } },
  "mark": { "type": "geoshape", "stroke": "#cccccc", "strokeWidth": 1, "fill": null } },
{
  "data": { "url": topoUrl, "format": { "type": "topojson", "feature": "ne_10m_admin_1_states_provinces" } },
  "transform": [
    { "filter": "datum.properties.iso_a2 === 'MY'" },
    { "calculate": mapNameCalc, "as": "state" },
    { "lookup": "state", "from": { "data": { "values": povertyData }, "key": "state",
                                   "fields": ["poverty_absolute","poverty_hardcore","poverty_relative"] } },
    { "filter": "isValid(datum.poverty_absolute) && datum.poverty_absolute >= minPoverty" },
    { "filter": "!stateFilter || datum.state === stateFilter" }
  ],
  "mark": { "type": "geoshape", "stroke": "#444", "strokeWidth": 0.6 },
  "encoding": {
    "color": { "field": "poverty_absolute", "type": "quantitative",
               "scale": { "type": "quantize", "domain": [0, 20], "scheme": "reds" },
               "title": "Absolute Poverty (%)",
               "legend": {
                 "title": "Absolute Poverty (%)",
                 "orient": "bottom",
                 "gradientLength": 200,
                 "format": ".1f",
                 "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 2) * 2, '.0f') : ''"
               } },
    "tooltip": [
      { "field": "state", "title": "State" },
      { "field": "poverty_absolute", "title": "Absolute Poverty (%)", "format": ".1f" },
      { "field": "poverty_hardcore", "title": "Hardcore Poverty (%)", "format": ".1f" },
      { "field": "poverty_relative", "title": "Relative Poverty (%)", "format": ".1f" }
    ]
  }
},
{
  "data": {
    "values": [
      {
        "state": "Sabah",
        "compareValue": 19.7,
        "anchorLon": 116.0,
        "anchorLat": 5.7,
        "textLon": 110.5,
        "textLat": 8.0,
        "label": "Highest Poverty: Sabah (19.7%)"
      }
    ]
  },
  "transform": [
    { "filter": "(!stateFilter || stateFilter === datum.state) && datum.compareValue >= minPoverty" }
  ],
  "layer": [
    {
      "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2] },
      "encoding": {
        "longitude": { "field": "anchorLon" },
        "latitude": { "field": "anchorLat" },
        "longitude2": { "field": "textLon" },
        "latitude2": { "field": "textLat" }
      }
    },
    {
      "mark": { "type": "text", "fontSize": 12, "fontWeight": "bold", "fill": "black", "align": "left", "baseline": "top", "dx": 6, "dy": -6 },
      "encoding": {
        "text": { "field": "label" },
        "longitude": { "field": "textLon" },
        "latitude": { "field": "textLat" }
      }
    }
  ]
}
]
};


// Scatter with income brush
const specScatter = {
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"background": chartBackground,
"data": { "values": combinedData },
"params": [
{ "name": "stateFilter", "value": null }
],
"vconcat": [
{
  "width": 840,
  "height": 320,
 "transform": [
   { "filter": "!stateFilter || datum.state === stateFilter" },
   { "filter": { "param": "incomeBrush" } }
 ],
 "layer": [
    {
      "data": { "values": combinedData },
      "transform": [
        { "filter": "!stateFilter && length(data('incomeBrush_store')) === 0" },
        {
          "regression": "poverty_absolute",
          "on": "income_median",
          "order": 3,
          "extent": [0, 12000]
        }
      ],
      "mark": {
        "type": "line",
        "color": "#d73027",
        "strokeDash": [6, 4],
        "strokeWidth": 2,
        "opacity": 0.28,
        "interpolate": "monotone"
      },
      "encoding": {
        "x": { "field": "income_median", "type": "quantitative" },
        "y": { "field": "poverty_absolute", "type": "quantitative" }
      }
    },
    {
      "mark": { "type": "point", "size": 110, "filled": true, "opacity": 0.9 },
      "encoding": {
        "x": { "field": "income_median", "type": "quantitative", "title": "Median Income (RM)",
               "scale": { "domain": [0, 12000] } },
        "y": { "field": "poverty_absolute", "type": "quantitative", "title": "Absolute Poverty (%)" },
        "color": {
          "field": "state",
          "type": "nominal",
          "title": "State",
          "legend": { "title": "State", "orient": "bottom", "columns": 8 },
          "scale": { "domain": stateDomain, "range": stateColorRange }
        },
        "tooltip": [
          { "field": "state", "title": "State" },
          { "field": "income_median", "title": "Median Income (RM)", "format": ",.0f" },
          { "field": "poverty_absolute", "title": "Absolute Poverty (%)", "format": ".1f" }
        ]
      }
    },
    {
      "mark": { "type": "text", "align": "left", "baseline": "middle", "dx": 7, "fontSize": 10 },
      "encoding": {
        "x": { "field": "income_median", "type": "quantitative" },
        "y": { "field": "poverty_absolute", "type": "quantitative" },
        "text": { "field": "state" },
       "color": {
         "field": "state",
         "type": "nominal",
         "legend": null,
         "scale": { "domain": stateDomain, "range": stateColorRange }
       }
      }
    },
    {
      "transform": [
        { "filter": "datum.state === 'Sabah'" },
        { "calculate": "datum.income_median + 2500", "as": "textX" },
        { "calculate": "datum.poverty_absolute - 3", "as": "textY" }
      ],
        "layer": [
           {
             "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2], "interactive": false },
           "encoding": {
             "x": { "field": "income_median", "type": "quantitative" },
             "y": { "field": "poverty_absolute", "type": "quantitative" },
             "x2": { "field": "textX", "type": "quantitative" },
            "y2": { "field": "textY", "type": "quantitative" }
          }
           },
           {
             "mark": { "type": "text", "fontSize": 12, "fontWeight": "bold", "fill": "black",
                       "align": "left", "baseline": "middle", "dx": 6, "interactive": false },
             "encoding": {
               "text": { "value": "Sabah is highest poverty, lower income" },
               "x": { "field": "textX", "type": "quantitative" },
               "y": { "field": "textY", "type": "quantitative" }
             }
        }
      ]
    },
    {
      "transform": [
        { "filter": "datum.state === 'Kuala Lumpur'" },
        { "filter": "!stateFilter || datum.state === stateFilter" },
        { "calculate": "datum.income_median", "as": "anchorX" },
        { "calculate": "datum.poverty_absolute", "as": "anchorY" },
        { "calculate": "datum.income_median - 2200", "as": "textX" },
        { "calculate": "datum.poverty_absolute + 3", "as": "textY" }
      ],
         "layer": [
           {
             "mark": { "type": "rule", "stroke": "#333", "strokeDash": [4, 2], "interactive": false },
           "encoding": {
             "x": { "field": "anchorX", "type": "quantitative" },
             "y": { "field": "anchorY", "type": "quantitative" },
             "x2": { "field": "textX", "type": "quantitative" },
            "y2": { "field": "textY", "type": "quantitative" }
          }
           },
           {
             "mark": { "type": "text", "fontSize": 12, "fontWeight": "bold", "fill": "black",
                       "align": "left", "baseline": "middle", "dx": 6, "interactive": false },
             "encoding": {
               "text": { "value": "KL is high income, low poverty" },
               "x": { "field": "textX", "type": "quantitative" },
               "y": { "field": "textY", "type": "quantitative" }
             }
        }
      ]
    }
  ]
},
{
  "width": 840,
  "height": 90,
  "title": { "text": "State Income Brush", "anchor": "middle", "fontSize": 14, "offset": 10 },
  "transform": [
    { "filter": "!stateFilter || datum.state === stateFilter" }
  ],
  "params": [
    {
      "name": "incomeBrush",
      "select": { "type": "interval", "encodings": ["x"], "empty": "all" }
    }
  ],
  "mark": { "type": "bar" },
  "encoding": {
    "x": { "field": "state", "type": "ordinal", "sort": { "field": "income_median", "order": "ascending" },
           "axis": { "labelAngle": -40 },
           "title": "State" },
    "y": { "field": "income_median", "type": "quantitative", "title": "Median Income (RM)" },
    "color": {
      "field": "state",
      "type": "nominal",
      "title": "State",
      "legend": { "title": "State", "orient": "bottom", "columns": 8 },
      "scale": { "domain": stateDomain, "range": stateColorRange }
    },
    "tooltip": [
      { "field": "state", "title": "State" },
      { "field": "income_median", "title": "Median Income (RM)", "format": ",.0f" }
    ]
  }
}
]
};


/* -------------------- HEATMAP (labels + annotations, explicit legend) -------------------- */
const specHeatmap = {
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"background": chartBackground,
"width": 860, "height": 420,
"data": { "values": combinedData },
"params": [
{ "name": "stateFilter", "value": null }
],
"transform": [
{ "filter": "!stateFilter || datum.state === stateFilter" },
{ "fold": ["income_median","poverty_absolute","poverty_hardcore","poverty_relative"],
  "as": ["metric","value"] },


/* readable metric labels */
{ "calculate":
    "datum.metric === 'income_median' ? 'Median income (RM)' : " +
    "datum.metric === 'poverty_absolute' ? 'Absolute poverty (%)' : " +
    "datum.metric === 'poverty_hardcore' ? 'Hardcore poverty (%)' : " +
    "'Relative poverty (%)'",
  "as": "metricLabel" },


/* min/max + count per metric */
{ "joinaggregate": [
    {"op":"min","field":"value","as":"mmin"},
    {"op":"max","field":"value","as":"mmax"},
    {"op":"count","field":"value","as":"mcount"}
  ],
  "groupby": ["metric"] },


/* normalize 0..1; invert poverty so higher=better */
{ "calculate": "(datum.value - datum.mmin) / (datum.mmax - datum.mmin)", "as": "norm" },
{ "calculate": "datum.metric === 'income_median' ? datum.norm : 1 - datum.norm", "as": "score" },


/* rank (descending) within each metric for annotations */
{ "window": [{"op":"rank","as":"rank_desc"}],
  "sort": [{"field":"value","order":"descending"}],
  "frame": [null, null],
  "groupby": ["metric"] },


/* value labels: RM 0dp, % 1dp */
{ "calculate": "datum.metric === 'income_median' ? format(datum.value, ',.0f') : format(datum.value, '.1f')",
  "as": "valueLabel" },


/* tooltip-friendly normalised label */
{ "calculate": "format(datum.score, '.2f')", "as": "scoreLabel" }
],


"layer": [
/* tiles with conditional outlines */
{
  "mark": "rect",
  "encoding": {
    "y": {"field":"state","type":"ordinal","sort":{"field":"income_median","order":"descending"},"title":"State"},
    "x": {"field":"metricLabel","type":"ordinal",
          "sort":["Median income (RM)","Absolute poverty (%)","Hardcore poverty (%)","Relative poverty (%)"],
          "axis":{"labelAngle":0},"title": null},
"color": {"field":"score","type":"quantitative","scale":{"type":"quantile","scheme":"blues"},
              "title": "Score",
              "legend": {
                "title": "Score (Bluer = Better)",
                "orient": "bottom",
                "gradientLength": 240,
                "format": ".1f",
                "labelExpr": "isFinite(datum.value) ? format(round(datum.value / 0.2) * 0.2, '.1f') : ''"
              }},
    "stroke": {
      "condition": [
        {"test": "datum.metric === 'income_median' && datum.rank_desc === 1", "value": "#0d1b2a"},      /* top income */
        {"test": "datum.metric === 'poverty_absolute' && datum.rank_desc === 1", "value": "#b22222"},    /* worst abs pov */
        {"test": "datum.metric === 'poverty_absolute' && datum.rank_desc === datum.mcount", "value": "#1f78b4"} /* best abs pov */
      ],
      "value": null
    },
    "strokeWidth": {
      "condition": [
        {"test": "datum.metric === 'income_median' && datum.rank_desc === 1", "value": 2},
        {"test": "datum.metric === 'poverty_absolute' && (datum.rank_desc === 1 || datum.rank_desc === datum.mcount)", "value": 2}
      ],
      "value": 0
    },
    "tooltip": [
      {"field":"state","title":"State"},
      {"field":"metricLabel","title":"Metric"},
      {"field":"valueLabel","title":"Original Value"},
      {"field":"scoreLabel","title":"Normalised Value"}
    ]
  }
},


/* value labels on top */
{
  "mark": {"type":"text","fontSize":10,"baseline":"middle","align":"center"},
  "encoding": {
    "y": {"field":"state","type":"ordinal","sort":{"field":"income_median","order":"descending"}},
    "x": {"field":"metricLabel","type":"ordinal",
          "sort":["Median income (RM)","Absolute poverty (%)","Hardcore poverty (%)","Relative poverty (%)"]},
    "text": {"field":"valueLabel"},
    "color": {
      "condition": [
        {"test": "datum.score >= 0.6", "value": "white"},
        {"test": "datum.score <= 0.25", "value": "#0d1b2a"}
      ],
      "value": "#0f3057"
    }
  }
}
]
};


// Parallel Coordinates (normalize so higher = better, add legend, fix tooltip)


const specSmallMultiples = {
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"background": chartBackground,
"data": { "values": combinedData },
"params": [
{ "name": "stateFilter", "value": null }
],
"transform": [
{ "fold": ["income_median", "income_mean", "poverty_absolute", "poverty_hardcore", "poverty_relative"],
  "as": ["metricField", "metricValue"] },
{ "calculate":
    "datum.metricField === 'income_median' ? 'Median income (RM)' : " +
    "datum.metricField === 'income_mean' ? 'Mean income (RM)' : " +
    "datum.metricField === 'poverty_absolute' ? 'Absolute poverty (%)' : " +
    "datum.metricField === 'poverty_hardcore' ? 'Hardcore poverty (%)' : " +
    "'Relative poverty (%)'",
  "as": "metricLabel" },
{ "calculate":
    "datum.metricField === 'income_median' || datum.metricField === 'income_mean' ? format(datum.metricValue, ',.0f') : format(datum.metricValue, '.1f')",
  "as": "metricValueLabel" }
,
{ "joinaggregate": [
    { "op": "count", "field": "state", "as": "metricCount" }
  ],
  "groupby": ["metricField"] },
{ "window": [
    { "op": "rank", "as": "metricRankDesc" }
  ],
  "sort": [{ "field": "metricValue", "order": "descending" }],
  "groupby": ["metricField"] },
{ "calculate":
    "datum.metricRankDesc === 1 ? 'Highest Value State' : datum.metricRankDesc === datum.metricCount ? 'Lowest Value State' : 'Others State'",
  "as": "metricRankCategory" }
,
{ "filter": "!stateFilter || datum.state === stateFilter" }
],
"facet": {
"column": {
  "field": "metricLabel",
  "type": "nominal",
  "sort": [
    "Median income (RM)",
    "Mean income (RM)",
    "Absolute poverty (%)",
    "Hardcore poverty (%)",
    "Relative poverty (%)"
  ],
  "title": null
},
"spacing": 20,
"align": { "column": "center" }
},
"spec": {
"width": 160,
"height": 320,
"mark": { "type": "bar" },
"encoding": {
  "y": { "field": "state", "type": "ordinal", "sort": { "field": "income_median", "order": "descending" }, "title": "State" },
  "x": { "field": "metricValue", "type": "quantitative", "title": "Metric Value" },
  "color": {
    "field": "metricRankCategory",
    "type": "nominal",
    "scale": {
      "domain": ["Highest Value State", "Lowest Value State", "Others State"],
      "range": ["#1f77b4", "#d62728", "#bfbfbf"]
    },
    "legend": {
      "title": "State ranking",
      "orient": "bottom",
      "direction": "horizontal",
      "values": ["Highest Value State", "Lowest Value State", "Others State"],
      "labelExpr": "datum.label"  /* keep full labels */
    }
  },
  "tooltip": [
    { "field": "metricLabel", "type": "nominal", "title": "Metric" },
    { "field": "state", "type": "nominal", "title": "State" },
    { "field": "region", "type": "nominal", "title": "Region" },
    { "field": "metricValueLabel", "type": "nominal", "title": "Value" }
  ]
}
},
"resolve": { "scale": { "x": "independent" } }
};


/* -------------------- Render + Slider Wiring -------------------- */


const statefulViews = [];
let currentStateFilter = null;


function applyStateFilter(view, value) {
view.signal('stateFilter', value).run();
}


function refreshStateFilterLabel() {
const labelEl = document.getElementById('state-filter-status');
if (!labelEl) return;
labelEl.textContent = currentStateFilter ? `Showing: ${currentStateFilter}` : 'Showing: All states';
}


function updateStateFilter(value) {
currentStateFilter = value;
statefulViews.forEach(view => applyStateFilter(view, value));
refreshStateFilterLabel();
}


function attachStateClickHandlers(view) {
view.addEventListener('click', (_, item) => {
const clickedState = item && item.datum && item.datum.state;
if (!clickedState) return;
updateStateFilter(clickedState === currentStateFilter ? null : clickedState);
});
view.addEventListener('dblclick', () => updateStateFilter(null));
}


function registerStatefulView(view, { enableClick = true } = {}) {
statefulViews.push(view);
if (currentStateFilter !== null) {
applyStateFilter(view, currentStateFilter);
}
if (enableClick) {
attachStateClickHandlers(view);
}
}


const clearStateButton = document.getElementById('state-filter-clear');
if (clearStateButton) {
clearStateButton.addEventListener('click', () => updateStateFilter(null));
}
refreshStateFilterLabel();


const mapViews = [];
const mapCenterOptions = {
national: { lon: 110, lat: 4.5, scale: 1300 },
peninsular: { lon: 102.5, lat: 4.5, scale: 2000 },
east: { lon: 113.5, lat: 3.8, scale: 1700 }
};
const mapConfig = { ...mapCenterOptions.national };


function applyMapSettingsToView(view) {
view.signal('mapScale', mapConfig.scale).run();
view.signal('mapCenterLon', mapConfig.lon).run();
view.signal('mapCenterLat', mapConfig.lat).run();
}


function registerMapView(view) {
mapViews.push(view);
applyMapSettingsToView(view);
}


function updateMapScale(scale) {
mapConfig.scale = scale;
mapViews.forEach(view => view.signal('mapScale', scale).run());
}


function updateMapCenter({ lon, lat }) {
mapConfig.lon = lon;
mapConfig.lat = lat;
mapViews.forEach(view => {
view.signal('mapCenterLon', lon).run();
view.signal('mapCenterLat', lat).run();
});
}


const mapZoomInput = document.getElementById('map-zoom');
if (mapZoomInput) {
mapZoomInput.value = mapConfig.scale;
mapZoomInput.addEventListener('input', e => updateMapScale(+e.target.value));
}


const mapCenterSelect = document.getElementById('map-center');
if (mapCenterSelect) {
mapCenterSelect.addEventListener('change', e => {
const option = mapCenterOptions[e.target.value] || mapCenterOptions.national;
if (mapZoomInput) {
  mapZoomInput.value = option.scale;
}
updateMapScale(option.scale);
updateMapCenter(option);
});
}


vegaEmbed("#vis-income", specIncome, { actions: false }).then(({ view }) => {
const slider = document.getElementById('income-slider');
const out = document.getElementById('slider-value-income');
out.textContent = slider.value;
view.signal('minIncome', +slider.value).run();
slider.addEventListener('input', e => {
const v = +e.target.value;
out.textContent = v;
view.signal('minIncome', v).run();
});
registerStatefulView(view);
registerMapView(view);
});


vegaEmbed("#vis-poverty", specPoverty, { actions: false }).then(({ view }) => {
const slider = document.getElementById('poverty-slider');
const out = document.getElementById('slider-value-poverty');
out.textContent = slider.value;
view.signal('minPoverty', +slider.value).run();
slider.addEventListener('input', e => {
const v = +e.target.value;
out.textContent = v;
view.signal('minPoverty', v).run();
});
registerStatefulView(view);
registerMapView(view);
});


vegaEmbed("#vis-scatter", specScatter, { actions: false }).then(({ view }) => {
registerStatefulView(view);
});


vegaEmbed("#vis-bar", specHeatmap, { actions: false }).then(({ view }) => {
registerStatefulView(view);
});  // heatmap here


vegaEmbed("#vis-small-multiples", specSmallMultiples, { actions: false }).then(({ view }) => {
registerStatefulView(view);
});


</script>
</body>
</html>
